---
layout: post
title: 자바 빌더 패턴
date: 2023-04-21 22:35 +0900
---

### 생성자와 정적 팩터리 메서드

- 선택적 매개변수가 많으면 적절히 대응하기 어려움

### 점층적 생성자 패턴

- 필수 매개변수만 받는 생성자(정적 팩터리 메서드)
- 필수 매개변수와 선택 매개변수를 받는 생성자(정적 팩터리 메서드)
  - 필요에 따라 다수 생성
- 매개변수의 개수가 많아지면 클라이언트 코드 작성이나 이해가 어려워짐
  - 각 매개변수 값의 의미
  - 매개변수 개수
  - 타입이 같은 매개변수
    - 매개변수 순서
- 런타임 에러 가능성

### 자바빈즈 패턴

- 매개변수가 없는 생성자로 객체 생성
- setter들을 호출, 원하는 매개변수 값 설정
  - 기본값이 있는 매개변수들은 기본값으로 초기화
- 장점
  - 점층적 생성자 패턴에 비해 인스턴스 생성과 코드 가독성에 용이
- 단점
  - 객체 하나의 생성을 위해 메서드를 여러 개 호출
  - 객체가 완전히 생성되기 전까지 일관성이 무너진 상태로 존재
    - 런타임 에러 가능성과 디버깅 어려움
  - [클래스를 불변](https://www.notion.so/17-d237c71d33fb44fa885aae6a8cf9e303)으로 만들 수 없음
  - 스레드 안정성을 위한 추가 작업 필요
  - 단점 완화를 위해 생성이 끝난 객체를 얼리기 전에 사용하지 못하도록 처리
    - 다루기 어려워 실전에서 거의 쓰이지 않음
    - 객체 사용 전 freeze 메서드를 사용했는지를 컴파일러가 보증해주지 않음

### 빌더 패턴

- 필요한 객체를 직접 만드는 대신, 빌더 객체를 이용
- **빌더 객체**
  1. **필수 매개변수**만으로 **생성자(정적 팩터리 메서드)**를 **호출**, **빌더 객체 반환**
  2. 빌더 객체가 제공하는 **setter 메서드로 선택 매개변수 지정**
  3. **매개변수가 없는 build** 메서드를 **호출**, **(보통 불변인) 객체 반환**
- 보통의 경우 빌더는 생성할 클래스 내부에 정적 멤버 클래스로 정의
- setter 메서드는 빌더 자신을 반환, **연쇄적 호출** 가능
  - Fluent API, Method Chaining 등으로 불림
- 명명된 선택적 매개변수를 흉내낸 것
- 구현
  - 빌더에서 선택 매개변수의 기본값 지정
  - 유효성 검사 코드 작성
  - 잘못된 매개변수 검사
    - 빌더의 생성자와 메서드에서 입력 매개변수를 검사
    - build 메서드가 호출하는 생성자에서 여러 매개변수에 거친 불변식 검사
      - [빌더로부터 매개변수 복사 후 해당 객체 필드들도 검사](https://www.notion.so/50-0a26316b3c014af1b0d6f3d41f607ad7)하여 불변식 보장
        - 불변(Immutable)은 어떠한 변경도 허용하지 않음을 의미
        - 불변식(invariant)은 프로그램 실행 시 반드시 만족해야 하는 조건을 의미
          - 주어진 조건 내에서만 변경 허용
    - 잘못된 매개변수 발견 시 자세한 메시지를 담아 IllegalArgumentException 투척
- 계층적으로 설계된 클래스에서의 빌더 패턴
  - 각 계층의 클래스에 관련 빌더를 멤버로 정의
    - 추상 클래스에는 추상 빌더 작성
    - 구체 클래스에는 구체 빌더 작성
  - 구현
    - 추상 빌더 클래스는 [재귀적 타입 한정](https://www.notion.so/30-872e5562202a486e91db5cea60d47e3d)을 사용하는 제네릭 타입
    - 추상 메서드인 self로 하위 클래스에서는 형변환 없이 메서드 연쇄 지원 가능
      - 시뮬레이트한 셀프 타입 관용구
        - self 타입이 없는 자바를 위한 우회 방법
    - 구체 빌더의 build 메소드는 구체 하위 클래스를 반환
      - 공변 반환 타이핑
        - 하위 클래스의 메서드가 상위 클래스의 메서드에서 정의한 반환 타입의 하위 타입을 반환하는 기능
        - 클라이언트가 형변환에 신경 쓰지 않고 빌더 사용 가능
- 장점
  - 코드 작성이 쉽고 가독성이 좋음
  - 가변인수 매개변수를 여러 개 사용 가능
    - 각각을 적절한 메서드로 나눠 선언
    - 메서드를 여러 번 호출, 각 호출 시 넘겨진 매개변수들을 하나의 필드에 저장
  - 하나의 빌더로 다수의 객체 생성 가능
  - 넘기는 매개변수에 따라 다른 객체 생성 가능
  - 일련번호 등의 특정 필드는 빌더가 알아서 할당하도록 지정 가능
  - 처리해야 할 매개변수가 많고, 특히 같은 타입인 경우 유리
- 단점
  - 객체를 만들기 전에 빌더를 먼저 만들어야 함
    - 생성 비용이 크지 않으나 성능이 민감한 상황에서 문제
  - 코드가 장황하여 매개변수가 4개 이상일 경우에 가치를 발휘
    - API는 시간이 지날수록 매개변수가 많아지는 경향
    - 애초에 빌더로 시작하는 편이 나을 때가 많음
